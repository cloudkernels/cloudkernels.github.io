<!DOCTYPE html>
<html  lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<title>Build a Nabla Docker Image | CloudKernels</title>



<link rel="stylesheet" href="/css/style.css"/><link rel='stylesheet' href='https://cloudkernels.github.io/css/custom.css'><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,600,600i,700,700i" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel="stylesheet">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/brands.css" integrity="sha384-1KLgFVb/gHrlDGLFPgMbeedi6tQBLcWvyNUN+YKXbD7ZFbjX6BLpMDf0PJ32XJfX" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/solid.css" integrity="sha384-+0VIRx+yz1WBcCTXBkVQYIBVNEFH1eP6Zknm16roZCyeNg2maWEpk/l/KsyFKs7G" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/fontawesome.css" integrity="sha384-jLuaxTTBR42U2qJ/pm4JRouHkEDHkVqH0T1nyQXn1mZ7Snycpf6Rl25VBNthU4z0" crossorigin="anonymous">
</head>
<body>

<section class="section">
  <div class="container">
    <nav class="nav menu">
      <div class="nav-left">
        <a class="nav-item" href="https://cloudkernels.github.io/">
          <h1 class="brand">CloudKernels</h1>
        </a>
      </div>
        
        <nav class="nav-item main-nav responsive">
        <ul class="main-menu">
          
          <li>
            <a href="/" title="Home"
                 class="nav-item">
               
                <span>Home</span>
            </a>
          </li>
		  
          <li>
            <a href="/about/" title="About"
                 class="nav-item">
               
                <span>About</span>
            </a>
          </li>
		  
          <li>
            <a href="/team/" title="Team"
                 class="nav-item">
               
                <span>Team</span>
            </a>
          </li>
		  
	    </ul>
		</nav>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
        <a href="#" class="main-menu-icon">
          <i class="fas fa-bars"></i>
        </a>
		<div class="social"><a class="level-item" aria-label="github" href='https://github.com/cloudkernels'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="twitter" href='https://twitter.com/cloudkernels'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
    
  </svg></i>
            </span>
          </a><a class="level-item" aria-label="email" href='mailto:team@cloudkernels.net'
            target='_blank' rel='noopener'>
            <span class="icon">
              <i class><svg viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
    
    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
    <polyline points="22,6 12,13 2,6"/>
    
  </svg></i>
            </span>
          </a></div>
        </nav>
      </div>
    </nav>
    <nav class="nav">
      

      
    </nav>

  </div>
</section>



<section class="section">
  <div class="container">
    <hr class="content-sep">
	
    
	<div>
    
	<span class="subtitle is-6">
      February 23, 2019
      
	</span>
	<ul class="social-share">
  <li class="twitter">
    <a href="https://twitter.com/intent/tweet/?text=Build%20a%20Nabla%20Docker%20Image&url=https%3a%2f%2fcloudkernels.github.io%2fposts%2fbuild-a-nabla-docker-image%2f?utm_source=twitter%26utm_medium=social%26utm_campaign=share_buttons" target="_share" title="Share on Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  <li class="twitter">
    <a href="https://reddit.com/submit?title=Build%20a%20Nabla%20Docker%20Image&amp;url=https%3a%2f%2fcloudkernels.github.io%2fposts%2fbuild-a-nabla-docker-image%2f?utm_source=reddit%26utm_medium=social%26utm_campaign=share_buttons" target="_share" title="Share on Reddit">
      <i class="fab fa-reddit"></i>
    </a>
  </li>
</ul>

	</div>
	<h1 class="title">
      <a href="https://cloudkernels.github.io/posts/build-a-nabla-docker-image/">Build a Nabla Docker Image</a>
	  
	</h1>
    
    <div class="content">
      

<p>In this post, we go through the basic steps for containerizing a unikernel
application and running it on nabla runnc. Checkout <a href="https://github.com/nabla-containers">nabla
containers</a> and in
particular <a href="https://github.com/nabla-containers/runnc">runnc</a>.</p>

<h3 id="how-to">How to</h3>

<p>In order to build a docker image for nabla containers, we have to build:</p>

<ul>
<li>the nabla toolstack</li>
<li>the unikernel image</li>
<li>the docker image</li>
</ul>

<h4 id="build-the-nabla-toolstack">Build the nabla toolstack</h4>

<p>There&rsquo;s an informative blog post on how to build the nabla rumprun toolstack
<a href="https://blog.cloudkernels.net/posts/building-nabla-aarch64/">here</a>. Now that
our aarch64 changes are upstream, the process should be as easy as the
following:</p>

<pre><code>git clone https://github.com/nabla-containers/rumrpun
cd rumprun
git submodule update --init
make
. obj/config-PATH.sh
</code></pre>

<p>and you should end up with the toolstack (${ARCH}-rumprun-netbsd-) in your PATH variable.</p>

<p>Alternatively you can use one of the (unofficial) docker images with the
toolstack embedded at /usr/local:</p>

<ul>
<li><a href="https://hub.docker.com/r/cloudkernels/debian-rumprun-build">x86_64-rumprun-netbsd-</a></li>
<li><a href="https://hub.docker.com/r/cloudkernels/debian-rumprun-build">aarch64-rumprun-netbsd-</a></li>
</ul>

<p>You can run these containers using the following command:</p>

<pre><code>docker run --runtime=runc --rm -v ${PWD}:/build -it cloudkernels/debian-rumprun-build:${ARCH} /bin/bash
</code></pre>

<p>where ${ARCH} could be x86_64 or aarch64.</p>

<h4 id="build-the-unikernel-image">Build the unikernel Image</h4>

<p>building the image is as easy as running the following:</p>

<pre><code>${ARCH}-rumprun-netbsd-gcc myprog.c -o myprog-rumprun
</code></pre>

<pre><code>rumprun-bake solo5-spt myprog.spt myprog-rumprun
</code></pre>

<p>So we have ourselves an .spt file (a unikernel). To try it out, assuming you
have a <a href="https://github.com/Solo5/solo5">solo5-spt</a> binary lying around you can
do the following:</p>

<pre><code>solo5-spt ./myprog.spt
</code></pre>

<p>Asumming the unikernel image is successful, its time to construct the docker image.</p>

<h4 id="build-the-docker-image">Build the docker image</h4>

<p>Rumprun is a quirky unikernel framework, with a number of assumptions we can&rsquo;t
ignore. Thus, in order to get the unikernel running correctly when in a nabla
container environmnent, we need to be careful and include the correct stubs for
a dummy root filesystem. So, clone <a href="https://github.com/cloudkernels/nabla-base">this
repo</a>, which contains the basic
rootfs from rumprun&rsquo;s lib/librumprunfs_base/rootfs, and a template Dockerfile
shown below:</p>

<pre><code>FROM scratch
COPY myprog.spt /myprog.nabla
COPY rootfs/etc /etc
ENTRYPOINT [ &quot;myprog.nabla&quot; ]
</code></pre>

<p>Copy the spt file in this directory and run:</p>

<pre><code>docker build -f Dockerfile -t myprog-nabla:${ARCH} .
</code></pre>

<p>You should end up with a local docker image named myprog-nabla, tagged with
your current architecture variant (x86_64 or aarch64).</p>

<p>Assuming you have setup <a href="https://github.com/nabla-containers/runnc">runnc</a>
correctly, spawning the container is as easy as:</p>

<pre><code>docker run --rm --runtime=runnc myprog-nabla:${ARCH}
</code></pre>

      
    </div>
    

  </div>
</section>


<section class="section footer">
  <div class="container">
	  <p><small>&copy; CloudKernels 2019-2022</small></p>
    
  </div>
</section>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-121797730-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="/js/social-share.js"></script>
<script src="/js/nav-responsive.js"></script>
</body>
</html>

