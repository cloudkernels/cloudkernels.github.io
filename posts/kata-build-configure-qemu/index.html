<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Kata Containers: Build and configure QEMU | CloudKernels</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://blog.cloudkernels.net/css/custom.css><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,300i,400,400i,600,600i,700,700i" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" rel=stylesheet><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.3/css/brands.css integrity=sha384-1KLgFVb/gHrlDGLFPgMbeedi6tQBLcWvyNUN+YKXbD7ZFbjX6BLpMDf0PJ32XJfX crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.3/css/solid.css integrity=sha384-+0VIRx+yz1WBcCTXBkVQYIBVNEFH1eP6Zknm16roZCyeNg2maWEpk/l/KsyFKs7G crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.6.3/css/fontawesome.css integrity=sha384-jLuaxTTBR42U2qJ/pm4JRouHkEDHkVqH0T1nyQXn1mZ7Snycpf6Rl25VBNthU4z0 crossorigin=anonymous></head><body><section class=section><div class=container><nav class="nav menu"><div class=nav-left><a class=nav-item href=https://blog.cloudkernels.net/><h1 class=brand>CloudKernels</h1></a></div><nav class="nav-item main-nav responsive"><ul class=main-menu><li><a href=/ title=Home class=nav-item><span>Home</span></a></li><li><a href=/about/ title=About class=nav-item><span>About</span></a></li><li><a href=/team/ title=Team class=nav-item><span>Team</span></a></li></ul></nav><div class=nav-right><nav class="nav-item level is-mobile"><a href=# class=main-menu-icon><i class="fas fa-bars"></i></a><div class=social><a class=level-item aria-label=github href=https://github.com/cloudkernels target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0 0 20 4.77 5.07 5.07.0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38.0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 0 0 5 4.77a5.44 5.44.0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 0 0 9 18.13V22"/></svg></i></span></a><a class=level-item aria-label=twitter href=https://twitter.com/cloudkernels target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M23 3a10.9 10.9.0 0 1-3.14 1.53 4.48 4.48.0 0 0-7.86 3v1A10.66 10.66.0 0 1 3 4s-4 9 5 13a11.64 11.64.0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5.0 0 0-.08-.83A7.72 7.72.0 0 0 23 3z"/></svg></i></span></a><a class=level-item aria-label=email href=mailto:team@cloudkernels.net target=_blank rel=noopener><span class=icon><i><svg viewbox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" aria-hidden="true"><path d="M4 4h16c1.1.0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1.0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><path d="M22 6 12 13 2 6"/></svg></i></span></a></div></nav></div></nav><nav class=nav></nav></div></section><section class=section><div class=container><hr class=content-sep><div><span class="subtitle is-6">March 28, 2022</span><ul class=social-share><li class=twitter><a href="https://twitter.com/intent/tweet/?text=Kata%20Containers%3a%20Build%20and%20configure%20QEMU&url=https%3a%2f%2fblog.cloudkernels.net%2fposts%2fkata-build-configure-qemu%2f?utm_source=twitter%26utm_medium=social%26utm_campaign=share_buttons" target=_share title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li class=twitter><a href="https://reddit.com/submit?title=Kata%20Containers%3a%20Build%20and%20configure%20QEMU&amp;url=https%3a%2f%2fblog.cloudkernels.net%2fposts%2fkata-build-configure-qemu%2f?utm_source=reddit%26utm_medium=social%26utm_campaign=share_buttons" target=_share title="Share on Reddit"><i class="fab fa-reddit"></i></a></li></ul></div><h1 class=title><a href=https://blog.cloudkernels.net/posts/kata-build-configure-qemu/>Kata Containers: Build and configure QEMU</a></h1><div class=content><p>Picking up from where we left in our <a href=https://blog.cloudkernels.net/posts/kata-build-source>previous
post</a>, we will now
install QEMU and configure Kata Containers to use QEMU as their hypervisor.</p><h3 id=build-qemu>Build QEMU</h3><p>First, we need to build <code>qemu-system</code> for the CPU architecture of our host machine. Kata Containers provide scripts to manage the build of QEMU both for
x86 and arm64 hosts. We will be using them to make sure that our QEMU installation is suitable for usage with Kata Containers.</p><h4 id=build-qemu-for-x86>Build QEMU for x86</h4><p>We need to get the correct version of QEMU from the versions file:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#0086b3>export</span> <span style=color:teal>GOPATH</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>$(</span>go env GOPATH<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:#0086b3>export</span> <span style=color:teal>GO111MODULE</span><span style=color:#000;font-weight:700>=</span>off
<span style=color:#0086b3>source</span> <span style=color:#d14>${</span><span style=color:teal>GOPATH</span><span style=color:#d14>}</span>/src/github.com/kata-containers/kata-containers/tools/packaging/scripts/lib.sh
<span style=color:teal>qemu_version</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>$(</span>get_from_kata_deps <span style=color:#d14>&#34;assets.hypervisor.qemu.version&#34;</span><span style=color:#000;font-weight:700>)</span></code></pre></div><p>Next, we need to get the QEMU source from the matching branch:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>go get -d github.com/qemu/qemu
<span style=color:#0086b3>cd</span> <span style=color:#d14>${</span><span style=color:teal>GOPATH</span><span style=color:#d14>}</span>/src/github.com/qemu/qemu
git checkout <span style=color:#d14>${</span><span style=color:teal>qemu_version</span><span style=color:#d14>}</span>
<span style=color:teal>your_qemu_directory</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>${</span><span style=color:teal>GOPATH</span><span style=color:#d14>}</span>/src/github.com/qemu/qemu</code></pre></div><p>We need to see which version of QEMU we will be building.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#0086b3>echo</span> <span style=color:#d14>${</span><span style=color:teal>qemu_version</span><span style=color:#d14>}</span>
<span style=color:#998;font-style:italic># v6.2.0</span></code></pre></div><p>Now we will use the scripts provided to apply the neccessary patches to QEMU. Make sure to change the commands below to match the version of QEMU that you are targeting.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:teal>packaging_dir</span><span style=color:#000;font-weight:700>=</span><span style=color:#d14>&#34;</span><span style=color:#d14>${</span><span style=color:teal>GOPATH</span><span style=color:#d14>}</span><span style=color:#d14>/src/github.com/kata-containers/kata-containers/tools/packaging&#34;</span>
<span style=color:teal>$packaging_dir</span>/scripts/apply_patches.sh <span style=color:teal>$packaging_dir</span>/qemu/patches/6.2.x/</code></pre></div><p>Once the patches are successfully applied, we need to install some apt packages that are required to build <code>qemu-system</code>:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt install ninja-build pkg-config <span style=color:#d14>\
</span><span style=color:#d14></span>  libglib2.0-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libpixman-1-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libseccomp-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libcap-ng-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  librados-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libpmem-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  librbd-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libgcrypt-dev</code></pre></div><p>Now, we can finally build QEMU:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#0086b3>cd</span> <span style=color:teal>$your_qemu_directory</span>
<span style=color:teal>$packaging_dir</span>/scripts/configure-hypervisor.sh kata-qemu &gt; kata.cfg
<span style=color:#0086b3>eval</span> ./configure <span style=color:#d14>&#34;</span><span style=color:#000;font-weight:700>$(</span>cat kata.cfg<span style=color:#000;font-weight:700>)</span><span style=color:#d14>&#34;</span>
make -j <span style=color:#000;font-weight:700>$(</span>nproc<span style=color:#000;font-weight:700>)</span>
sudo -E make install</code></pre></div><p>If you followed the instructions in our previous post and you have set the <code>PREFIX</code> variable to <code>/opt/kata</code> the <code>qemu-system-x86_64</code> binary will be stored under the <code>/opt/kata/bin/</code> directory, <code>tools/virtiofsd/virtiofsd</code> under the <code>/opt/kata/libexec/kata-qemu</code> directory and all the other files will be stored under the <code>/opt/kata/share/kata-qemu</code> directory.</p><p>We can also install <code>virtiofsd</code> and <code>qemu-system-x86_64</code> under the default location using the <code>install_qemu.sh</code> script.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>go get -d github.com/kata-containers/tests
script -fec <span style=color:#d14>&#39;sudo -E ${GOPATH}/src/github.com/kata-containers/tests/.ci/install_qemu.sh&#39;</span></code></pre></div><h4 id=build-qemu-for-aarch64>Build QEMU for aarch64</h4><p>Install requierements:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt-get install -y build-essential pkg-config <span style=color:#d14>\
</span><span style=color:#d14></span>  libglib2.0-dev libpixman-1-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libaio-dev libseccomp-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  libcap-ng-dev librados-dev <span style=color:#d14>\
</span><span style=color:#d14></span>  librbd-dev libzstd-dev</code></pre></div><p>Set required environment variables</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#0086b3>export</span> <span style=color:teal>PATH</span><span style=color:#000;font-weight:700>=</span><span style=color:teal>$PATH</span>:<span style=color:#000;font-weight:700>$(</span>go env GOPATH<span style=color:#000;font-weight:700>)</span>/bin <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:#d14>\
</span><span style=color:#d14></span>  <span style=color:#0086b3>export</span> <span style=color:teal>GOPATH</span><span style=color:#000;font-weight:700>=</span><span style=color:#000;font-weight:700>$(</span>go env GOPATH<span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:#d14>\
</span><span style=color:#d14></span>  <span style=color:#0086b3>export</span> <span style=color:teal>GO111MODULE</span><span style=color:#000;font-weight:700>=</span>off</code></pre></div><p>Build QEMU using the <code>install_qemu.sh</code> script:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo rm -rf <span style=color:#d14>${</span><span style=color:teal>GOPATH</span><span style=color:#d14>}</span>/src/github.com/qemu/qemu <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:#d14>\
</span><span style=color:#d14></span>  go get -d github.com/kata-containers/tests <span style=color:#000;font-weight:700>&amp;&amp;</span> <span style=color:#d14>\
</span><span style=color:#d14></span>  script -fec <span style=color:#d14>&#39;sudo -E ${GOPATH}/src/github.com/kata-containers/tests/.ci/install_qemu.sh&#39;</span></code></pre></div><h3 id=configure-kata-containers>Configure Kata Containers</h3><p>Next, we need to install the Kata Containers configuration file. We will use this file to configure Kata Containers to use the initrd image we built in our previous post. You could also use a rootfs image, if you prefer.
We will also enable guest <code>seccomp</code>.</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo mkdir -p /opt/kata/configs
sudo install -o root -g root -m <span style=color:#099>0640</span> /opt/kata/share/defaults/kata-containers/configuration.toml /opt/kata/configs
<span style=color:#998;font-style:italic># comment out the image entry</span>
sudo sed -i <span style=color:#d14>&#39;s/^\(image =.*\)/# \1/g&#39;</span> /opt/kata/configs/configuration.toml
<span style=color:#998;font-style:italic># enable seccomp</span>
sudo sed -i <span style=color:#d14>&#39;/^disable_guest_seccomp/ s/true/false/&#39;</span> /opt/kata/configs/configuration.toml</code></pre></div><p>Make sure that <code>/opt/kata/configs/configuration.toml</code> has a initrd entry pointing to the initrd we created:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#099>17</span>   | <span style=color:#998;font-style:italic>#image = &#34;/opt/kata/share/kata-containers/kata-containers-image.img&#34;</span>
<span style=color:#099>18</span>   │ <span style=color:teal>initrd</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#d14>&#34;/opt/kata/share/kata-containers/kata-containers-initrd.img&#34;</span></code></pre></div><h3 id=configure-containerd>Configure containerd</h3><p>You need to edit the containerd config file (usually <code>/etc/containerd/config.toml</code>.</p><p>First we need to remove <code>cri</code> from the diabled plugins list:</p><pre><code>#disabled_plugins = [&quot;cri&quot;]
disabled_plugins = []
</code></pre><p>We also need to add the relevant handler for the kata runtime:</p><pre><code>[plugins]
  [plugins.cri]
    [plugins.cri.containerd]
      [plugins.cri.containerd.runtimes]
        [plugins.cri.containerd.runtimes.kata]
         runtime_type = &quot;io.containerd.kata.v2&quot;
         privileged_without_host_devices = true
         [plugins.cri.containerd.runtimes.kata.options]
           ConfigPath = &quot;/opt/kata/configs/configuration.toml&quot;
</code></pre><p>Once the changes are saved, restart containerd: <code>sudo systemctl restart containerd</code>.</p><p>To verify our installation is successfull, we can launch an Ubuntu test container:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo ctr images pull docker.io/library/ubuntu:latest
sudo ctr run --runtime io.containerd.run.kata.v2 -t --rm docker.io/library/ubuntu:latest ubuntu-kata-test uname -a
<span style=color:#998;font-style:italic># Linux e678ab3c6fc3 5.15.26 #2 SMP Sat Mar 19 21:02:56 UTC 2022 aarch64 aarch64 aarch64 GNU/Linux</span></code></pre></div><p><strong>Note 1 for aarch64</strong>:</p><p>We noticed that, in some instances, trying to launch a container produced the following error:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#998;font-style:italic># sudo ctr images pull docker.io/library/busybox:latest</span>
<span style=color:#998;font-style:italic># ctr run --runtime io.containerd.run.kata.v2 -t --rm docker.io/library/busybox:latest hello1 sh</span>
ctr: failed to create shim: failed to launch qemu: <span style=color:#0086b3>exit</span> status <span style=color:#099>1</span>, error messages from qemu log: qemu-system-aarch64: warning: For GICv2 max-cpus must be equal to smp-cpus
qemu-system-aarch64: warning: Overriding specified max-cpus<span style=color:#000;font-weight:700>(</span><span style=color:#099>4</span><span style=color:#000;font-weight:700>)</span> with smp-cpus<span style=color:#000;font-weight:700>(</span><span style=color:#099>1</span><span style=color:#000;font-weight:700>)</span>
qemu-system-aarch64: warning: global kvm-pit.lost_tick_policy has invalid class name
Restoring <span style=color:#099>1</span> CPU interfaces, kernel only has <span style=color:#099>4</span>
: unknown</code></pre></div><p>A workaround for that problem was to set the <code>default_vcpus = 8</code> in <code>/opt/kata/configs/configuration.toml</code>.</p><p><strong>Note 2 for aarch64</strong>:</p><p>We tried running on an older kernel, on an NVIDIA Jetson AGX Xavier and on an
NVIDIA Jetson Nano, versions 4.9.253-tegra-virt (getting KVM to work on these
boards is also quite a challenge, more details on a subsequent post). Apart
from the GIC issue above, we saw that virtio-fs is not backported, nor is there
support for the nvdimm stuff, so the following changes to the config file are
needed:</p><div class=highlight><pre style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-patch data-lang=patch><span style=color:#000;background-color:#fdd>--- configuration-qemu-stock.toml   2022-03-24 20:55:47.010284096 +0000
</span><span style=color:#000;background-color:#fdd></span><span style=color:#000;background-color:#dfd>+++ configuration-qemu.toml    2022-03-24 21:34:39.725554126 +0000
</span><span style=color:#000;background-color:#dfd></span><span style=color:#aaa>@@ -103,7 +103,7 @@
</span><span style=color:#aaa></span> # vCPUs supported by the SB/VM. In general, we recommend that you do not edit this variable,
 # unless you know what are you doing.
 # NOTICE: on arm platform with gicv2 interrupt controller, set it to 8.
<span style=color:#000;background-color:#fdd>-default_maxvcpus = 0
</span><span style=color:#000;background-color:#fdd></span><span style=color:#000;background-color:#dfd>+default_maxvcpus = 1
</span><span style=color:#000;background-color:#dfd></span>
 # Bridges can be used to hot plug devices.
 # Limitations:
<span style=color:#aaa>@@ -151,7 +151,7 @@
</span><span style=color:#aaa></span> #   - virtio-fs (default)
 #   - virtio-9p
 #   - virtio-fs-nydus
<span style=color:#000;background-color:#fdd>-shared_fs = &#34;virtio-fs&#34;
</span><span style=color:#000;background-color:#fdd></span><span style=color:#000;background-color:#dfd>+shared_fs = &#34;virtio-9p&#34;
</span><span style=color:#000;background-color:#dfd></span>
 # Path to vhost-user-fs daemon.
 virtio_fs_daemon = &#34;/opt/kata/libexec/kata-qemu/virtiofsd&#34;
<span style=color:#aaa>@@ -292,7 +292,7 @@
</span><span style=color:#aaa></span> # nvdimm is not supported when `confidential_guest = true`.
 #
 # Default is false
<span style=color:#000;background-color:#fdd>-#disable_image_nvdimm = true
</span><span style=color:#000;background-color:#fdd></span><span style=color:#000;background-color:#dfd>+disable_image_nvdimm = true
</span><span style=color:#000;background-color:#dfd></span>
 # VFIO devices are hotplugged on a bridge by default.
 # Enable hotplugging on root bus. This may be required for devices with
</code></pre></div><p>Interenstingly enough, <code>default_vcpus</code> must be equal to <code>default_maxvcpus</code> on
such platforms.</p></div></div></section><section class="section footer"><div class=container><p><small>&copy; CloudKernels 2019-2022</small></p></div></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-121797730-2','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script><script src=https://code.jquery.com/jquery-3.3.1.min.js></script><script src=/js/social-share.js></script><script src=/js/nav-responsive.js></script></body></html>